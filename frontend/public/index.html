<!-- index.html includes Pi SDK script from Pi dev portal -->
<script>
  /**
   * Authenticates a user via the Pi Network SDK.
   * Handles SDK initialization, authentication flow, and error management.
   * Designed for clarity, extensibility, and seamless integration.
   */
  async function loginWithPi() {
    // Replace with your actual client ID and set network to 'mainnet' in production.
    const clientId = 'YOUR_CLIENT_ID';
    const network = 'testnet';

    try {
      // Initialize Pi SDK
      const { account } = await Pi.initializer({ clientId, network });

      // Request user authentication
      const authResponse = await account.requestAuth({
        app: { name: 'Palace of Quests' },
        permissions: ['testnet_access'],
      });

      if (authResponse.status === 'success' && authResponse.account) {
        console.info(`Logged in as: ${authResponse.account.username}`);

        // Optionally, trigger UI updates or backend sync here
        // Example: updateUserUI(authResponse.account);

        return authResponse.account;
      } else {
        const message = authResponse.error || 'Login failed for an unknown reason.';
        console.warn(`Login failed: ${message}`);
        // Optionally, display a user-friendly message in your UI here
        return null;
      }
    } catch (err) {
      // Handles unexpected errors such as network or SDK issues
      console.error('Unexpected error during Pi login:', err);
      // Optionally, show a generic error message to the user here
      return null;
    }
  }
</script>
<script>
  // DOM elements for user feedback
  const loginBtn = document.getElementById("pi-login-btn");
  const statusMsg = document.getElementById("login-status");

  async function loginWithPi() {
    statusMsg.textContent = "Connecting to Pi Networkâ€¦";
    loginBtn.disabled = true;

    const clientId = "YOUR_CLIENT_ID"; // Replace with your real Pi client ID
    const network = "testnet"; // Change to 'mainnet' in production

    try {
      const { account } = await Pi.initializer({ clientId, network });

      const authResponse = await account.requestAuth({
        app: { name: "Palace of Quests" },
        permissions: ["testnet_access"],
      });

      if (authResponse.status === "success" && authResponse.account) {
        statusMsg.textContent = `Logged in as: ${authResponse.account.username}`;
        // Send the token to backend for verification and session storage
        await sendLoginToBackend(authResponse.accessToken);
        // You can update UI or trigger further actions here
      } else {
        showError(authResponse.error || "Login failed. Please try again.");
      }
    } catch (err) {
      showError("Could not log in. Please check your connection and try again.");
      console.error("Pi login error:", err);
    } finally {
      loginBtn.disabled = false;
    }
  }

  async function sendLoginToBackend(accessToken) {
    try {
      const res = await fetch("/api/pi-login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ access_token: accessToken }),
      });

      if (res.ok) {
        const data = await res.json();
        statusMsg.textContent = `Welcome, ${data.username}!`;
      } else {
        const err = await res.text();
        showError("Backend rejected login: " + err);
      }
    } catch (err) {
      showError("Network error during backend login.");
      console.error("Backend login error:", err);
    }
  }

  function showError(message) {
    statusMsg.textContent = message;
    statusMsg.style.color = "#b00020";
  }
</script>

<!-- Example HTML -->
<button id="pi-login-btn" onclick="loginWithPi()">Login with Pi Network</button>
<div id="login-status"></div>
